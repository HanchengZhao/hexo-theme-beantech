<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Henry&#39;s thoughts">
  <meta name="keyword" content>
  <link rel="shortcut icon" href="/img/hz_logo.JPG">
  <!-- Place this tag in your head or just before your close body tag. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script async defer src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.min.js"></script>
  <title>
     Automatically create merge requests through gitlab api - Henry Zhao 
  </title>

  <link rel="canonical" href="http://hzhao.me/2019/04/03/Automatically-create-merge-request-through-gitlab-api/">

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css">

  <!-- Pygments Highlight CSS -->
  <link rel="stylesheet" href="/css/highlight.css"> <link rel="stylesheet" href="/css/widget.css"> <link rel="stylesheet" href="/css/rocket.css">
  <link rel="stylesheet" href="/css/signature.css"> <link rel="stylesheet" href="/css/toc.css">

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.min.css" rel="stylesheet" type="text/css">

  <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- ga & ba script hoook -->
  <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('gitlab-blog-cover.png')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#gitlab" title="gitlab">gitlab</a>
                            
                              <a class="tag" href="/tags/#bash" title="bash">bash</a>
                            
                              <a class="tag" href="/tags/#node" title="node">node</a>
                            
                        </div>
                        <h1>Automatically create merge requests through gitlab api</h1>
                        <h2 class="subheading">Laziness creates efficiency</h2>
                        <span class="meta">
                            Posted by Henry Zhao on
                            2019-04-03
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Henry Zhao</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="background">Background</h2>
<p>Kubernetes is the new trend to manage cloud-based applications and also our main tool for orchestration. Each of our service is running inside an individual docker container and we use <a href="https://helm.sh/docs/developing_charts/" target="_blank" rel="noopener">helm charts</a> to configure each pod. For codebase management, we use gitlab, which is perfect for collaboration inside a team that hosts code server by themselves.</p>
<p>In production, everytime that we update our service version (either front end or back end), we need to update the hash inside the helm charts. Since we have a requirement for release notes to include <strong>bug fix</strong> or <strong>new features</strong>, <strong>related commits</strong> or <strong>tickets</strong> have to be included inside the body of gitlab merge request.</p>
<p>We are all lazy developers and try to avoid tedious work that could be automated by codes.</p>
<p>So the <strong>workflow</strong> I want to achieve is that whenever we merge a feature branch to the <strong>master</strong>, we collect all the <strong>related issues</strong> and <strong>squashed commits</strong>. Ideally, we set a merge request <strong>interval</strong> to avoid too frequent merge requests. Then we compare the latest master hash and the one in the helm charts, checking if the interval is longer enough for us to create a new merge request. Last but not the least, the whole step should be a phase in the gitlab CI.</p>
<p>Luckily, <a href="https://docs.gitlab.com/ee/api/" target="_blank" rel="noopener">gitlab API</a> provides all the functions we need.</p>
<h2 id="tools">Tools</h2>
<p>Before we proceed, we need a set of command line tools to boost our efficiency.</p>
<h3 id="jq">jq</h3>
<blockquote>
<p>jq is like sed for JSON data<br>
You can use <code>jq</code> to easily extract useful information and format them in the way you want. For example:</p>
</blockquote>
<ul>
<li>extract the first element from a <code>json array</code>:</li>
</ul>
<p><code>cat json | jq .[0]</code></p>
<ul>
<li>get a new json in the given format:</li>
</ul>
<p><code>jq '.[] | {message: .commit.message, name: .commit.committer.name}'</code></p>
<p>You can even use conditional operator or loop functions with <code>jq</code>, which is definitely worth checking out the <a href="https://stedolan.github.io/jq/manual/" target="_blank" rel="noopener">manual</a> if you are dealing with json form cli a lot.</p>
<h3 id="yq">yq</h3>
<p>yq is similar to jq, but especially for <code>yaml</code> files. It’s also written in python.</p>
<h3 id="gsedsed">gsed(sed)</h3>
<p><code>sed</code> is a very handy tool on the unix system to perform basic text transformations on an input stream. However, <code>sed</code> on the <code>linux</code> and <code>mac</code> has slight differences, so we can use <code>gsed</code> here to keep it consistent.</p>
<h3 id="curl">curl</h3>
<p><code>curl</code> is basically the postman on the command line, which will be our best friend to test apis from the terminal.</p>
<h3 id="base64">base64</h3>
<p><code>base64</code> encoding is a common way to use textual data to store the binary data or serialize the files.</p>
<h2 id="step-by-step">Step by step</h2>
<p>I’m using <a href="https://www.npmjs.com/package/gitlab" target="_blank" rel="noopener">node client</a> from gitlab here, but you can use any language to write the script.</p>
<h3 id="import-the-dependencies">Import the dependencies</h3>
<p>Here’s the modules that I use:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ProjectsBundle &#125; = <span class="built_in">require</span>(<span class="string">"gitlab"</span>);</span><br><span class="line"><span class="keyword">const</span> yaml = <span class="built_in">require</span>(<span class="string">"js-yaml"</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> exec = <span class="built_in">require</span>(<span class="string">"await-exec"</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">"lodash"</span>);</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">"moment"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="fetch-helm-chart-file">Fetch helm-chart file</h3>
<p>We use gitlab client to set up the project info:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> service = <span class="keyword">new</span> ProjectsBundle(&#123;</span><br><span class="line">  url: HOST,</span><br><span class="line">  token: PRIVATE_TOKEN,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Then we fetched the <code>values.yaml</code> file.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> valuesFile = <span class="keyword">await</span> service.RepositoryFiles.show(</span><br><span class="line">    HELM_CHART_PROJECT_ID,</span><br><span class="line">    <span class="string">"path/to/values.yaml"</span>,</span><br><span class="line">    <span class="string">"master"</span></span><br><span class="line">  );</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">"Unable to fetch values.yaml file. ❌"</span>);</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The response we get from the api so far is encoded in <code>base64</code>, so we need to decode it in plain text:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; content &#125; = valuesFile;</span><br><span class="line"><span class="keyword">const</span> generatedFile = <span class="keyword">await</span> exec(</span><br><span class="line">  <span class="string">`echo <span class="subst">$&#123;content&#125;</span> | base64 --decode &gt; values.yaml`</span>,</span><br><span class="line">  puts</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="compare-the-commit-diff-and-time-diff">Compare the commit diff and time diff</h3>
<p>Next, We check whether the commit hash changed and whether time interval met our requirement, otherwise we don’t need to make next move.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get commit hash from helm chart</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> doc = yaml.safeLoad(fs.readFileSync(<span class="string">"./values.yaml"</span>, <span class="string">"utf8"</span>));</span><br><span class="line">   hashInHelm = doc.image.tag;</span><br><span class="line"> &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">   <span class="built_in">console</span>.error(e);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">const</span> oldCommit = <span class="keyword">await</span> service.Commits.show(PROJECT_ID, hashInHelm);</span><br><span class="line"> lastCommitTime = oldCommit[<span class="string">"created_at"</span>];</span><br><span class="line"> <span class="keyword">let</span> sinceTime = moment(lastCommitTime)</span><br><span class="line">   .add(<span class="number">1</span>, <span class="string">"minutes"</span>)</span><br><span class="line">   .format();</span><br><span class="line"> <span class="keyword">const</span> fetchMasterCommits = <span class="keyword">await</span> exec(</span><br><span class="line">   <span class="string">`curl -H "PRIVATE-TOKEN:<span class="subst">$&#123;PRIVATE_TOKEN&#125;</span>" <span class="subst">$&#123;HOST&#125;</span>/api/v4/projects/<span class="subst">$&#123;PROJECT_ID&#125;</span>/repository/commits?since=<span class="subst">$&#123;sinceTime&#125;</span>`</span></span><br><span class="line"> );</span><br><span class="line"> <span class="keyword">if</span> (fetchMasterCommits.error) &#123;</span><br><span class="line">   <span class="built_in">console</span>.error(<span class="string">`fetchMasterCommits error: <span class="subst">$&#123;fetchMasterCommits.error&#125;</span> ❌`</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> masterCommits = <span class="built_in">JSON</span>.parse(fetchMasterCommits.stdout);</span><br><span class="line"> <span class="keyword">if</span> (masterCommits.length === <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">"The hash in the helm chart is the latest one."</span>);</span><br><span class="line">   process.exit(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> hashInRepo = masterCommits[<span class="number">0</span>].short_id;</span><br><span class="line"> <span class="keyword">const</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"> <span class="keyword">const</span> lastUpdateDate = <span class="keyword">new</span> <span class="built_in">Date</span>(lastCommitTime)</span><br><span class="line"> <span class="comment">// only continue the script when the hash changed and the time diff is large than the setting</span></span><br><span class="line"> <span class="keyword">if</span> (</span><br><span class="line">   hashInHelm !== hashInManifold &amp;&amp;</span><br><span class="line">   currentDate - lastUpdateDate &gt; TIME_INTERVAL</span><br><span class="line"> ) &#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>get related <code>merge requests</code> and <code>commit messages</code></li>
</ul>
<p>In order to create a merge request with enough information, we can fetch merge requests and commit messages that are related to this specific commit.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> description = &#123;</span><br><span class="line">  commits: [],</span><br><span class="line">  issues: [],</span><br><span class="line">&#125;;</span><br><span class="line">masterCommits</span><br><span class="line">  .map(<span class="function"><span class="params">commit</span> =&gt;</span> commit.id)</span><br><span class="line">  .forEach(<span class="keyword">async</span> id =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> mergeRequests;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      mergeRequests = <span class="keyword">await</span> service.Commits.mergeRequests(PROJECT_ID, id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`Unable to fetch merge requests for <span class="subst">$&#123;id&#125;</span>. <span class="subst">$&#123;e&#125;</span> ❌`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if no merge requests found, just use the commit message</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(mergeRequests) &amp;&amp; mergeRequests.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> c = _.find(masterCommits, o =&gt; o.id === id);</span><br><span class="line">      description.commits.push(<span class="string">`<span class="subst">$&#123;c.short_id&#125;</span> - <span class="subst">$&#123;c.message&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// otherwise, format the description as [title](web_url)</span></span><br><span class="line">      mergeRequests</span><br><span class="line">        .map(<span class="function"><span class="params">m</span> =&gt;</span> m.iid)</span><br><span class="line">        .forEach(<span class="keyword">async</span> iid =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> closedIssues = <span class="keyword">await</span> service.MergeRequests.closesIssues(</span><br><span class="line">            PROJECT_ID,</span><br><span class="line">            iid</span><br><span class="line">          );</span><br><span class="line">          closedIssues.forEach(<span class="function"><span class="params">issue</span> =&gt;</span> &#123;</span><br><span class="line">            description.issues.push(<span class="string">`[<span class="subst">$&#123;issue.title&#125;</span>](<span class="subst">$&#123;issue.web_url&#125;</span>)\n`</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>Create a new merge request</li>
</ul>
<p>In the final step, we create a new branch and apply the hash change that we made. Then we make a new merge request with all the useful information.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newBranch = <span class="string">`change-hash-<span class="subst">$&#123;hashInManifold&#125;</span>`</span>;</span><br><span class="line"><span class="comment">// replace the hash</span></span><br><span class="line"><span class="keyword">let</span> updatedFile = <span class="keyword">await</span> exec(</span><br><span class="line">  <span class="string">`sed -i 's/<span class="subst">$&#123;hashInHelm&#125;</span>/<span class="subst">$&#123;hashInManifold&#125;</span>/' values.yaml`</span>,</span><br><span class="line">  puts</span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Updated hash in values.yaml. ✅"</span>);</span><br><span class="line"><span class="keyword">let</span> BASE64_yaml = base64_encode(<span class="string">"values.yaml"</span>);</span><br><span class="line"><span class="keyword">const</span> Payload = &#123;</span><br><span class="line">  branch: newBranch,</span><br><span class="line">  content: BASE64_yaml,</span><br><span class="line">  commit_message: <span class="string">`update hash to <span class="subst">$&#123;hashInManifold&#125;</span>`</span>,</span><br><span class="line">  encoding: <span class="string">"base64"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> createNewBranch = <span class="keyword">await</span> service.Branches.create(</span><br><span class="line">  HELM_CHART_PROJECT_ID,</span><br><span class="line">  newBranch,</span><br><span class="line">  <span class="string">"master"</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Created a branch <span class="subst">$&#123;newBranch&#125;</span> in helm-chart repo. ✅`</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> updatedFileInHelm = <span class="keyword">await</span> exec(<span class="string">`curl --request PUT --header 'PRIVATE-TOKEN:<span class="subst">$&#123;PRIVATE_TOKEN&#125;</span>' --header "Content-Type: application/json" \</span></span><br><span class="line"><span class="string">      --data '<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(</span></span></span><br><span class="line"><span class="string"><span class="subst">        Payload</span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span>' "<span class="subst">$&#123;HOST&#125;</span>/api/v4/projects/<span class="subst">$&#123;HELM_CHART_PROJECT_ID&#125;</span>/repository/files/charts%2Fdata-engine%2Fvalues.yaml"`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Updated value.yaml file in helm-chart repo. ✅`</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">`Unable to update file. ❌`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * projectId: ProjectId,</span></span><br><span class="line"><span class="comment"> * sourceBranch: string,</span></span><br><span class="line"><span class="comment"> * targetBranch: string,</span></span><br><span class="line"><span class="comment"> * title: string,</span></span><br><span class="line"><span class="comment"> * options: RequestOptions,</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> createMr = <span class="keyword">await</span> service.MergeRequests.create(</span><br><span class="line">  HELM_CHART_PROJECT_ID,</span><br><span class="line">  newBranch,</span><br><span class="line">  <span class="string">"master"</span>,</span><br><span class="line">  <span class="string">"WIP: update manifold hash"</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    description: <span class="string">`</span></span><br><span class="line"><span class="string">## Description</span></span><br><span class="line"><span class="string">### related commits</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;_.uniq(description.commits).join(<span class="string">"\n"</span>)&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### related issues:</span></span><br><span class="line"><span class="string"><span class="subst">$&#123;_.uniq(description.issues).join(<span class="string">"\n"</span>)&#125;</span>`</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Created a merge request in helm-chart repo. ✅"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Here is the link: <span class="subst">$&#123;createMr.web_url&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>
<h2 id="things-to-improve">Things to improve</h2>
<p>Above are a relatively simple and straightforward way to create merge requests base on changes. We did observe several problems in the process and find improvements to be done in future.</p>
<ul>
<li>
<p>Only create MRs in batches or close the MRs that are included in the current MR. MRs are created for each change now, then populate the whole merge list if the previous ones are not merge in time.</p>
</li>
<li>
<p>It would be nice that we provide a link with <code>Create MR</code> button for users to trigger the creation.</p>
</li>
<li>
<p>Better code abstraction for different project usage.</p>
</li>
<li>
<p>Better organization of description and commit messages.</p>
</li>
</ul>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/2018/05/07/Treechart-In-D3/" data-toggle="tooltip" data-placement="top" title="Treechart In D3">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#background"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Background</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#tools"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Tools</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#jq"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">jq</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#yq"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">yq</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#gsedsed"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">gsed(sed)</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#curl"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">curl</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#base64"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">base64</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#step-by-step"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Step by step</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#import-the-dependencies"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Import the dependencies</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#fetch-helm-chart-file"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">Fetch helm-chart file</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#compare-the-commit-diff-and-time-diff"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Compare the commit diff and time diff</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#things-to-improve"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Things to improve</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#gitlab" title="gitlab">gitlab</a>
                        
                          <a class="tag" href="/tags/#bash" title="bash">bash</a>
                        
                          <a class="tag" href="/tags/#node" title="node">node</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://blog.yewang.host" target="_blank">Ye Wang Blog</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "henryzhao";
    var disqus_identifier = "http://hzhao.me/2019/04/03/Automatically-create-merge-request-through-gitlab-api/";
    var disqus_url = "http://hzhao.me/2019/04/03/Automatically-create-merge-request-through-gitlab-api/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/hanchengzhao">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/HanchengZhao">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Henry Zhao 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org">BeanTech</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    modified by <a href="http://hzhao.me">Henry Zhao</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://hzhao.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-72269431-2';
    var _gaDomain = 'hzhao.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->






	<!-- <a id="rocket" href="#top" class=""></a> -->
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://hzhao.me/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
